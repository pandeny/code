# 阶段划分方法改进说明

## 问题描述

原有的阶段划分方法（`segment_load_by_threshold` 和 `simple_segmentation`）存在精度不足的问题：

- **过度分割**: 对于96个时间点（24小时数据），会产生39个或23个段，导致分析结果难以理解
- **噪声敏感**: 对负荷数据中的小波动过于敏感，将正常的噪声误判为阶段变化
- **缺乏时间连续性考虑**: 没有考虑负荷变化的时间连续性特征

## 改进方案

### 核心改进点

1. **时间序列平滑处理**
   - 使用移动平均（窗口大小=5，约1小时）对负荷数据进行平滑
   - 减少噪声对阶段划分的影响

2. **变化点检测**
   - 计算负荷的一阶导数（变化率）
   - 识别显著的变化点（导数绝对值超过阈值或符号改变）
   - 只在真正的负荷变化点进行阶段切分

3. **最小段长度约束**
   - 设置最小段长度为6个点（1.5小时）
   - 防止产生过短的无意义段落

4. **相似段落合并**
   - 合并负荷水平相似（差异<15%）的相邻段落
   - 进一步减少过度分割

### 算法流程

```
输入: 负荷值序列
  ↓
步骤1: 移动平均平滑处理
  ↓
步骤2: 计算一阶导数，识别变化点
  ↓
步骤3: 基于分位数进行初始状态分类
  ↓
步骤4: 结合变化点识别初始段落
  ↓
步骤5: 合并过短的段落（< min_segment_length）
  ↓
步骤6: 合并负荷水平相似的相邻段落（差异 < 15%）
  ↓
输出: 精简的段落列表
```

## 改进效果对比

### example_interpretability.py

**改进前:**
- 段落数: 39个
- 问题: 过度分割，难以理解

**改进后:**
- 段落数: 3-4个
- 效果: 
  - 阶段1 (0-3h): 夜间低负荷
  - 阶段2 (3-19h): 白天中等负荷
  - 阶段3 (19-24h): 晚间高负荷

### load_interpretability_demo.py

**改进前:**
- 段落数: 23个
- 问题: 分割过细，阶段意义不明确

**改进后:**
- 段落数: 3-4个
- 效果: 清晰识别夜间、白天、晚高峰三个主要阶段

## 参数说明

### segment_load_by_threshold / simple_segmentation

```python
def segment_load_by_threshold(load_values, n_segments=4, min_segment_length=6):
    """
    Args:
        load_values: 负荷值数组
        n_segments: 目标段数（建议范围：3-8）
        min_segment_length: 最小段长度（时间点数），默认6个点（1.5小时）
    """
```

**推荐参数设置:**
- `n_segments`: 4-5 （24小时数据）
- `min_segment_length`: 6-8 （1.5-2小时）

## 技术细节

### 1. 平滑处理
```python
window_size = 5
smoothed_load = np.convolve(load_values, np.ones(window_size)/window_size, mode='same')
```

### 2. 变化点检测
```python
# 计算一阶导数
derivative[1:-1] = (smoothed_load[2:] - smoothed_load[:-2]) / 2

# 识别显著变化点
derivative_threshold = np.std(derivative) * 0.5
if abs(derivative[i]) > derivative_threshold and \
   (derivative[i] * derivative[i-1] < 0 or ...):
    change_points.append(i)
```

### 3. 段落合并策略
```python
# 负荷水平差异小于15%时合并
load_diff_pct = abs(next_mean - mean_load) / mean_load * 100
if load_diff_pct < 15:
    # 合并两个段落
    ...
```

## 与HMM方法的关系

本次改进针对的是**简单分段方法**（用于演示和快速分析）。系统中还保留了更高级的**HMM（隐马尔可夫模型）分段方法**（在`train_household_forecast.py`中），用于更精确的预测和分析场景。

两种方法的对比：

| 特性 | 改进的简单分段 | HMM分段 |
|------|--------------|---------|
| 复杂度 | 低 | 高 |
| 依赖 | 仅NumPy | 需要hmmlearn |
| 速度 | 快 | 较慢 |
| 精度 | 良好 | 优秀 |
| 适用场景 | 演示、快速分析 | 生产预测 |

## 测试验证

### 测试用例1: 标准家庭模式
```
输入: 96个点，包含夜间、白天、晚高峰
输出: 3个段落
  - 0-3h: 低负荷 (0.52kW)
  - 3-19h: 中等负荷 (1.03kW)  
  - 19-24h: 高负荷 (2.44kW)
```

### 测试用例2: 周末模式
```
输入: 96个点，晚起床、白天在家
输出: 4个段落
  - 0-5h: 低负荷
  - 5-10h: 中低负荷（起床推迟）
  - 10-19h: 中高负荷（白天在家）
  - 19-24h: 高负荷
```

## 后续优化建议

1. **自适应阈值**: 根据数据特征动态调整合并阈值
2. **季节性考虑**: 考虑不同季节的负荷模式差异
3. **用户习惯学习**: 学习特定用户的用电习惯，优化阈值

## 总结

通过引入时间序列分析技术和智能合并策略，新的阶段划分方法在保持简单易用的同时，显著提高了划分精度：

✅ **段落数量**: 从39/23个减少到3-4个
✅ **可解释性**: 段落边界与实际用电行为高度吻合
✅ **稳定性**: 对噪声的鲁棒性显著提升
✅ **实用性**: 生成的分析报告更易理解和应用

这使得系统生成的可解释性分析报告更加精准、实用，便于用户理解负荷变化模式和制定用能策略。
