# 预测模式中的多历史时期负荷对比分析

## 概述

在预测模式中，系统现在会自动将预测日负荷与历史负荷（7天前、3天前、1天前）进行对比分析，并生成详细的对比报告。这个功能可以帮助用户理解：

1. **阶段数量变化** - 预测日与历史时期相比，负荷阶段数量的增减
2. **阶段时间偏移** - 阶段的左移（提前）或右移（推迟）
3. **负荷水平变化** - 各阶段负荷的增加或减少
4. **行为模式解释** - 基于人的行为习惯提供变化原因

## 功能特点

### 自动触发

当在预测模式中对某个日期进行预测时，系统会：

1. 自动查找该日期前1天、3天、7天的历史数据
2. 对历史负荷进行阶段划分
3. 将预测日负荷阶段与历史阶段进行对比
4. 生成多历史时期对比分析报告

### 对比维度

#### 1. 阶段数量变化
- 对比预测日与各历史时期的阶段数量
- 分析阶段数量增加或减少的趋势
- 提供基于行为的解释（如：周末在家时间长，用电模式多样化）

**示例输出：**
```
【1】阶段数量变化趋势
--------------------------------------------------------------------------------

与1天前相比:
  预测日阶段数: 5
  历史阶段数: 4
  变化: +1 个阶段 (+25.0%)

与3天前相比:
  预测日阶段数: 5
  历史阶段数: 4
  变化: +1 个阶段 (+25.0%)
```

#### 2. 时间偏移分析
- 检测阶段的时间偏移（右移/推迟 或 左移/提前）
- 识别显著偏移（> 1小时）的阶段
- 解释偏移原因（如：周末起床时间推迟，早高峰后移2小时）

**示例输出：**
```
【差异阶段 1】
  预测日阶段 2 ↔ 历史阶段 3
  时间范围:
    预测日: 10.0h-14.2h
    历史: 7.5h-12.5h
  ⏰ 时间偏移: +2.1 小时 (右移/推迟)
  🔍 行为解释:
    • 早高峰阶段时间推迟约2.1小时，可能是：因为周末/假日导致起床时间推迟、或作息时间调整
```

#### 3. 负荷水平变化
- 对比预测日与历史阶段的负荷水平
- 识别显著差异（> 20%）的阶段
- 提供基于时间段的行为解释

**示例输出：**
```
  📊 负荷变化:
    预测日负荷: 1.8165
    历史负荷: 0.8041
    变化量: +1.0124 (+125.9%)
    变化类型: 增加
  🔍 行为解释:
    • 上午时段负荷增加，可能是：在家办公、使用更多电器、或家庭成员未外出
```

#### 4. 跨时期趋势总结
- 分析3个历史时期的整体趋势
- 识别一致性模式（如：持续右移、持续增加）
- 提供综合性的行为模式解释

**示例输出：**
```
【跨时期行为模式总结】
• 与过去[1, 3, 7]天相比，负荷阶段持续右移(推迟)，说明作息时间逐渐推迟，可能是周末/假日效应
• 与历史时期相比，负荷整体呈上升趋势，可能原因：在家时间增加、新增用电设备、季节性需求上升
```

## 输出文件

预测模式会生成以下与多历史时期对比相关的文件：

1. **文本报告** - `multi_historical_comparison_YYYYMMDD.txt`
   - 详细的对比分析报告
   - 包含所有对比维度和行为解释
   - 适合人工阅读和分析

2. **JSON文件** - `multi_historical_comparison_YYYYMMDD.json`
   - 结构化的对比数据
   - 方便程序化处理和进一步分析
   - 包含所有原始数据和计算结果

## 使用方法

### 在预测模式中自动运行

1. 启动程序并选择"预测模式"
2. 选择已保存的模型
3. 选择要预测的日期
4. 系统会自动执行多历史时期对比分析并生成报告

### 查看报告

报告保存在预测结果目录下：
```
output/analysis/{model_name}/predictions/
  ├── multi_historical_comparison_20240114.txt  # 文本报告
  ├── multi_historical_comparison_20240114.json # JSON数据
  ├── prediction_detail_20240114.csv            # 预测详情
  └── prediction_with_stages_20240114.png       # 预测图表
```

## 示例场景

### 场景：预测周日（2024-01-14）的负荷

假设：
- 预测日：2024-01-14（周日）
- 1天前：2024-01-13（周六）
- 3天前：2024-01-11（周四，工作日）
- 7天前：2024-01-07（周日）

**预期分析结果：**

1. **与3天前（工作日）对比**
   - 早高峰右移约2小时（6-8h → 8-10h）
   - 原因：周末起床时间推迟
   - 白天负荷显著增加
   - 原因：周末在家时间长，用电设备使用增多

2. **与1天前和7天前（周末）对比**
   - 阶段数量相近
   - 时间偏移较小
   - 原因：周末模式相对稳定

## 技术实现

### 核心函数

1. **prepare_historical_data_for_comparison**
   - 准备历史数据（1, 3, 7天前）
   - 对历史负荷进行阶段划分
   - 提取环境特征

2. **compare_predicted_with_multiple_historical_stages**
   - 执行多历史时期对比分析
   - 识别阶段数量、时间偏移、负荷变化
   - 生成行为模式解释

3. **generate_multi_historical_comparison_report**
   - 生成格式化的文本报告
   - 包含所有对比维度和解释

### 集成位置

功能集成在 `plot_single_day_prediction` 函数中，会在以下情况自动触发：
- 预测模式中对某个日期进行预测
- 存在足够的历史数据（至少1天前的数据）

## 注意事项

1. **数据可用性**
   - 如果历史数据不存在，系统会跳过相应时期的对比
   - 至少需要1天前的数据才能进行对比分析

2. **阶段划分**
   - 使用HMM智能阶段划分算法
   - 如果HMM不可用，自动降级到简单分段方法

3. **时间偏移判断**
   - 显著偏移定义为 ≥ 1小时
   - 负荷显著差异定义为 > 20%

4. **性能考虑**
   - 对比分析在预测完成后自动执行
   - 不影响预测性能
   - 报告生成速度快（通常 < 1秒）

## 应用价值

1. **负荷预测验证** - 通过与历史对比，验证预测的合理性
2. **用电行为分析** - 理解用户用电模式的变化趋势
3. **异常检测** - 识别与历史显著不同的用电模式
4. **需求响应** - 为需求侧管理提供行为洞察
5. **能源管理** - 优化能源使用策略

## 未来扩展

可能的扩展方向：
1. 自定义对比时期（如：14天前、30天前）
2. 工作日/周末自动分组对比
3. 季节性对比分析
4. 可视化对比图表
5. 自动生成优化建议

## 参考文档

- [多历史时期负荷对比分析示例](MULTI_HISTORICAL_COMPARISON_EXAMPLE.md)
- [实现总结](IMPLEMENTATION_SUMMARY_MULTI_HISTORICAL.md)
- [负荷变化可解释性模型](INTERPRETABILITY_MODEL.md)
