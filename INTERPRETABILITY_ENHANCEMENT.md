# 负荷预测可解释性增强说明

## 概述

本次更新增强了负荷预测的可解释性功能，主要新增以下三个关键特性：

1. **历史负荷对比分析**：与1天前、3天前、7天前的负荷进行对比
2. **预测日用电特征概括**：简要概括预测日的整体用电特征
3. **增强的人类行为关联描述**：更详细地描述用电与人类行为的关联

## 新增功能详解

### 1. 历史负荷对比分析

#### 功能说明
系统现在会自动将预测日的负荷与历史负荷（1/3/7天前）进行对比，分析负荷变化趋势和原因。

#### 对比维度
- **1天前对比**：识别短期负荷变化，反映近期用电习惯调整
- **3天前对比**：识别中期趋势，可能反映周中/周末差异
- **7天前对比**：识别周同比变化，反映周期性规律

#### 输出内容
```
【历史负荷对比分析】
与1天前对比:
  历史负荷: 1.2112
  预测负荷: 1.2750
  变化量: +0.0638 (+5.3%)
  解释: 负荷略有增加，用电活动有所增强

与7天前(上周同日)对比:
  历史负荷: 1.1475
  预测负荷: 1.2750
  变化量: +0.1275 (+11.1%)
  解释: 相比上周同日负荷略有增加

综合趋势:
  预测日负荷与历史水平基本持平，用电模式保持稳定
```

#### 变化解释规则
- **显著增加** (>20%)：季节变化、活动增多、新增用电设备
- **略有增加** (5-20%)：用电活动有所增强
- **基本持平** (<5%)：用电习惯稳定
- **略有减少** (-20% - -5%)：用电活动有所降低
- **显著减少** (<-20%)：外出、节能或设备停用

### 2. 预测日用电特征概括

#### 功能说明
自动生成预测日的整体用电特征摘要，包括统计指标、显著特征和行为模式。

#### 统计指标
- 日总负荷
- 日均负荷
- 峰值负荷
- 谷值负荷
- 负荷标准差
- 负荷阶段数

#### 显著特征识别

**负荷波动特征**：
- 波动显著（变异系数>0.5）：用电活动集中度高
- 波动适中（0.2-0.5）：符合典型家庭用电模式
- 相对平稳（<0.2）：用电活动分布均匀

**峰谷差特征**：
- 峰谷差较大（>5倍）：高峰时段用电设备集中使用
- 峰谷差适中（3-5倍）：用电活动有明显时段特征
- 峰谷差较小（<3倍）：全天用电较为均衡

#### 输出示例
```
【预测日用电特征概括】
日总负荷: 122.40
日均负荷: 1.2750
峰值负荷: 2.8000
谷值负荷: 0.5000
负荷标准差: 0.7791
负荷阶段数: 5

显著特征:
  • 负荷波动显著，说明用电活动集中度高
  • 峰谷差较大(5.6倍)，高峰时段用电设备集中使用

人类行为关联:
  • 早晨活跃：起床后的洗漱、早餐准备等活动形成早高峰
  • 傍晚活跃：家庭成员返回后的晚餐、娱乐等活动形成晚高峰
```

### 3. 增强的人类行为关联描述

#### 功能说明
在阶段分析中，系统现在提供更详细的人类行为描述，突出用电与日常生活的关联。

#### 时段行为模式

**早高峰（6-9时）**：
> 起床、洗漱、早餐准备，照明、热水器、厨房电器等设备启用

**上午时段（9-12时）**：
> 多数家庭成员外出上班/上学，仅基础待机负荷

**午间时段（12-14时）**：
> 部分成员返家午餐或使用微波炉加热，照明和烹饪用电

**下午时段（14-18时）**：
> 持续低负荷，冰箱等基础设备运行

**晚高峰（18-22时）**：
> 家庭成员返回，晚餐烹饪、照明、电视、空调等集中使用

**夜间时段（22-6时）**：
> 准备睡眠，仅冰箱、路由器等待机负荷

#### 输出示例
```
阶段 1:
  时间范围: 0.00h - 6.00h (持续 6.00小时)
  负荷水平: 低负荷 (平均值: 0.5000)
  关键影响因素:
    • 夜间时段 - 准备睡眠，仅冰箱、路由器等待机负荷
    • 低温(8.5°C)可能增加供暖负荷
    • 负荷相对稳定(标准差=0.025)

阶段 2:
  时间范围: 6.00h - 9.00h (持续 3.00小时)
  负荷水平: 高负荷 (平均值: 1.8000)
  关键影响因素:
    • 早高峰时段 - 起床、洗漱、早餐准备，照明、热水器、厨房电器等设备启用
    • 温度适中(18.0°C)
```

## 技术实现

### 代码修改位置

**文件**：`train_household_forecast.py`

**主要修改函数**：
1. `explain_load_changes()` - 第709-1154行
   - 新增历史对比分析逻辑（第974-1096行）
   - 新增预测日概括逻辑（第1098-1152行）
   - 增强行为描述（第808-822行）

2. `generate_explanation_report()` - 第1168-1296行
   - 新增预测日概括部分（第1237-1256行）
   - 新增历史对比部分（第1258-1287行）

### 数据依赖

函数需要以下数据：
- `segments`: 负荷分段信息
- `feat_df`: 特征数据框（必须包含 `lag_1d`, `lag_7d`, `median_past7_same_time` 列）
- `pred_times`: 预测时间点列表
- `load_values`: 负荷值数组

### 关键算法

**历史对比算法**：
```python
pred_mean = np.mean(load_values)
hist_mean = np.mean(historical_loads)
change_pct = (pred_mean - hist_mean) / hist_mean * 100
```

**负荷变异系数**：
```python
load_variation = std(load) / mean(load)
```

**峰谷比**：
```python
peak_valley_ratio = max(load) / min(load)
```

## 使用方法

### 自动集成

在运行预测系统时，这些新功能会**自动执行**：

```bash
python train_household_forecast.py
# 选择预测模式
# 输入预测日期
# 系统自动生成包含新功能的完整报告
```

### 输出文件

系统会在输出目录自动生成：
- `explanation_report_YYYYMMDD.txt` - 包含所有新增分析的完整报告
- `explanation_viz_YYYYMMDD.png` - 可视化图表
- `explanation_YYYYMMDD.json` - JSON格式的结构化数据

### 示例报告

完整的报告包含以下部分（按顺序）：

1. **阶段详细分析** - 包含增强的行为描述
2. **阶段间趋势变化分析**
3. **特征重要性分析**
4. **环境因素综合影响**
5. **预测日用电特征概括** ⭐ 新增
6. **历史负荷对比分析** ⭐ 新增

## 应用价值

### 1. 能源管理优化
- 通过历史对比识别异常用电
- 根据峰谷差优化用电时段
- 发现节能潜力

### 2. 用户行为洞察
- 了解家庭成员的日常作息
- 识别用电习惯变化
- 预测未来用电趋势

### 3. 负荷成因分析
- 将负荷变化与人类活动关联
- 识别环境因素影响
- 提供可操作的优化建议

## 测试验证

运行测试脚本验证功能：

```bash
python test_simple_interpretability.py
```

预期输出：
```
✅ 所有测试通过！

新增功能验证:
  ✅ 历史负荷对比分析（1/3/7天）
  ✅ 预测日用电特征概括
  ✅ 增强的人类行为关联描述
  ✅ 完整的解释报告生成
```

## 注意事项

1. **数据要求**：系统需要至少7天的历史数据才能完成完整的对比分析
2. **特征对齐**：确保 `feat_df` 包含正确的滞后特征列
3. **时间同步**：`pred_times` 必须与 `feat_df` 的索引对齐
4. **异常处理**：所有分析都包含异常处理，失败不会影响其他部分

## 未来改进方向

1. **多周期对比**：支持与14天、30天前的对比
2. **季节性分析**：识别季节变化对负荷的影响
3. **异常检测**：自动标记异常用电模式
4. **个性化建议**：基于分析结果提供节能建议

## 更新日志

**版本**: 2024-01-15
**作者**: GitHub Copilot
**变更**:
- 新增历史负荷对比分析（1/3/7天）
- 新增预测日用电特征概括
- 增强人类行为关联描述
- 更新报告生成格式

---

有关更多技术细节，请参考：
- [IMPLEMENTATION_SUMMARY.md](IMPLEMENTATION_SUMMARY.md) - 完整实现总结
- [README_INTERPRETABILITY.md](README_INTERPRETABILITY.md) - 可解释性功能指南
- [train_household_forecast.py](train_household_forecast.py) - 源代码
