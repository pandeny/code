# 多历史时期负荷对比分析示例

## 场景说明

**预测日：** 2024-01-14 (周日 - 周末模式)

**历史对比时期：**
- 1天前 (2024-01-13, 周六 - 周末模式)
- 3天前 (2024-01-11, 周四 - 工作日模式)
- 7天前 (2024-01-07, 周日 - 周末模式)

## 功能说明

`compare_predicted_with_multiple_historical_stages` 函数用于将预测日负荷与多个历史时期（默认7/3/1天前）进行对比分析，识别：
1. **阶段数量变化** - 阶段数增加或减少的趋势
2. **阶段时间偏移** - 阶段的左移（提前）或右移（推迟）
3. **负荷水平变化** - 各阶段负荷的增加或减少
4. **行为模式解释** - 基于人的行为习惯提供变化原因

## 使用方法

```python
from train_household_forecast import compare_predicted_with_multiple_historical_stages

# 准备历史数据字典
historical_data_dict = {
    1: {  # 1天前
        'segments': hist_1day_segments,
        'feat_df': hist_1day_df,
        'times': hist_1day_times,
        'load': hist_1day_load
    },
    3: {  # 3天前
        'segments': hist_3day_segments,
        'feat_df': hist_3day_df,
        'times': hist_3day_times,
        'load': hist_3day_load
    },
    7: {  # 7天前
        'segments': hist_7day_segments,
        'feat_df': hist_7day_df,
        'times': hist_7day_times,
        'load': hist_7day_load
    }
}

# 执行多历史时期对比
multi_comparison = compare_predicted_with_multiple_historical_stages(
    predicted_segments,          # 预测日的负荷阶段
    historical_data_dict,        # 历史数据字典
    predicted_feat_df,           # 预测日特征数据
    predicted_times,             # 预测日时间点
    predicted_load,              # 预测日负荷值
    comparison_days=[1, 3, 7]    # 要对比的历史天数
)
```

## 输出结果示例

### 1. 阶段数量变化趋势

```
与1天前相比:
  预测日阶段数: 24
  历史阶段数: 22
  变化: +2 个阶段 (+9.1%)

与3天前相比:
  预测日阶段数: 24
  历史阶段数: 18
  变化: +6 个阶段 (+33.3%)

与7天前相比:
  预测日阶段数: 24
  历史阶段数: 23
  变化: +1 个阶段 (+4.3%)
```

**解释：** 与3天前(工作日)相比，预测日(周末)的阶段数显著增加，说明周末在家时间长，用电模式更加多样化。

### 2. 与3天前(工作日)的详细对比

#### 显著差异阶段示例

**阶段 3 (预测日) ↔ 阶段 2 (3天前):**
```
时间范围: 8.0h-10.0h (预测) vs 6.0h-8.0h (历史)
⏰ 时间偏移: +2.0 小时 (右移/推迟)
⚡ 负荷变化: +0.8 kW (+32.0%)
📝 解释:
   • 早高峰阶段时间推迟约2.0小时，可能是：因为周末/假日导致起床时间推迟、或作息时间调整
   • 早高峰时段负荷增加，可能是：起床时间提前、早餐准备更复杂、或增加了热水器/咖啡机使用
```

**阶段 8 (预测日) ↔ 阶段 5 (3天前):**
```
时间范围: 12.0h-16.0h (预测) vs 12.0h-18.0h (历史)
⏰ 时间偏移: 0.0 小时 (无偏移)
⚡ 负荷变化: +1.2 kW (+150.0%)
📝 解释:
   • 下午时段负荷增加，可能是：在家时间增加、使用娱乐设备、或提前准备晚餐
```

**阶段 12 (预测日) ↔ 阶段 10 (3天前):**
```
时间范围: 19.0h-21.0h (预测) vs 18.0h-20.0h (历史)
⏰ 时间偏移: +1.0 小时 (右移/推迟)
⚡ 负荷变化: +0.5 kW (+16.7%)
📝 解释:
   • 晚高峰阶段时间推迟约1.0小时，可能是：下班/回家时间推迟、或晚餐时间调整
   • 晚高峰时段负荷增加，可能是：回家时间提前、晚餐准备更复杂、家庭娱乐活动增加、或使用更多照明和空调
```

#### 行为模式总结 (与3天前)
```
• 共识别出5个差异显著的负荷阶段
• 时间偏移模式：整体右移(推迟)为主，3个阶段有显著时间偏移（3个右移，0个左移）
• 偏移原因：可能是周末/假日作息推迟、工作时间调整、或生活习惯改变
• 整体趋势：负荷增加为主(4个阶段增加，1个阶段减少)
• 可能原因：家庭活动增加、在家时间延长、新增用电设备、或季节性用电需求变化
```

### 3. 跨时期综合行为模式分析

```
1. 与过去[1, 3, 7]天相比，负荷阶段数变化不一致，说明用电模式存在波动

2. 与过去[1, 3, 7]天相比，负荷阶段持续右移(推迟)，说明作息时间逐渐推迟，
   可能是周末/假日效应、或生活习惯改变

3. 与历史时期相比，负荷整体呈上升趋势，可能原因：在家时间增加、
   新增用电设备、季节性需求上升
```

### 4. 时间偏移趋势

```
与1天前相比:
  有2个阶段发生时间偏移
  右移(推迟): 1个阶段
  左移(提前): 1个阶段
  主导方向: 混合

与3天前相比:
  有3个阶段发生时间偏移
  右移(推迟): 3个阶段
  左移(提前): 0个阶段
  主导方向: 右移(推迟)

与7天前相比:
  有1个阶段发生时间偏移
  右移(推迟): 1个阶段
  左移(提前): 0个阶段
  主导方向: 右移(推迟)
```

**分析：** 与工作日(3天前)相比，周末预测日的阶段明显右移，说明作息时间推迟。与其他周末(1天前、7天前)相比，偏移较小，说明周末模式相对稳定。

### 5. 负荷变化趋势

```
与1天前相比:
  差异显著的阶段: 2个
  负荷增加: 1个阶段
  负荷减少: 1个阶段

与3天前相比:
  差异显著的阶段: 5个
  负荷增加: 4个阶段
  负荷减少: 1个阶段

与7天前相比:
  差异显著的阶段: 1个
  负荷增加: 1个阶段
  负荷减少: 0个阶段
```

**分析：** 与工作日相比，周末负荷显著增加，特别是白天时段。与其他周末相比，负荷水平相似。

## 实际应用示例

### 示例1：周末 vs 工作日对比

**场景：** 预测周日负荷，与周四(3天前)对比

**主要发现：**
- 早高峰右移2小时（6-8h → 8-10h）：周末起床晚
- 白天负荷增加150%：周末在家时间长
- 晚高峰右移1小时：周末作息推迟

**行为解释：**
> 因为是周末，起床时间推迟，早高峰后移2小时。白天在家时间长，使用更多娱乐设备和家用电器，负荷显著提高。晚上就寝时间也推迟，整体作息时间右移。

### 示例2：假期效应分析

**场景：** 预测假期第3天负荷，与假期前工作日(7天前)对比

**主要发现：**
- 阶段数增加6个：假期生活更加随意
- 所有高峰阶段右移1-3小时：作息时间全面推迟
- 整体负荷增加25%：在家时间长，用电量大

**行为解释：**
> 假期期间作息时间整体推迟，早晨睡懒觉，晚上熬夜，导致所有用电高峰阶段右移。在家时间长，使用各种家电设备，负荷水平显著提高。

### 示例3：季节变化分析

**场景：** 预测冬季某日，与1周前(同为冬季)对比

**主要发现：**
- 阶段数基本不变：作息稳定
- 时间偏移不显著：生活规律
- 早晚负荷增加15%：气温下降

**行为解释：**
> 同一季节作息时间相对稳定，阶段数和时间偏移变化不大。但由于气温进一步下降，早晚供暖需求增加，导致这两个时段负荷上升。

## 技术要点

### 时间偏移计算

时间偏移通过比较对齐阶段的中心点时间计算：
```python
time_shift = curr_mid_hour - hist_mid_hour
```

- **正值**：右移（推迟），如 +2.0 表示推迟2小时
- **负值**：左移（提前），如 -1.5 表示提前1.5小时
- **阈值**：|time_shift| >= 1.0 小时视为显著偏移

### 负荷变化检测

负荷变化通过百分比判断：
```python
load_diff_pct = (curr_mean - hist_mean) / hist_mean * 100
```

- **阈值**：|load_diff_pct| > 20% 视为显著变化

### 行为解释规则

基于时间段和变化类型的规则引擎：

| 时间段 | 时间偏移 | 负荷变化 | 解释 |
|--------|---------|---------|------|
| 早高峰(6-9h) | 右移 | - | 起床时间推迟，周末/假日效应 |
| 早高峰(6-9h) | - | 增加 | 早餐准备更复杂，用电设备增加 |
| 白天(9-18h) | - | 增加 | 在家时间增加，周末/假日在家 |
| 白天(9-18h) | - | 减少 | 外出时间增加，工作日外出 |
| 晚高峰(18-22h) | 右移 | - | 回家/晚餐时间推迟 |
| 晚高峰(18-22h) | - | 增加 | 家庭活动增加，娱乐设备使用多 |
| 夜间(22-24h) | 右移 | - | 就寝时间推迟 |

## 数据结构

### 输入数据格式

```python
# 预测日阶段
predicted_segments = [
    (start_idx, end_idx, state, mean_load),
    # 例如: (0, 23, 0, 0.5) 表示从第0个点到第23个点，状态0，平均负荷0.5kW
    ...
]

# 历史数据字典
historical_data_dict = {
    days_ago: {
        'segments': [...],          # 阶段列表
        'feat_df': pd.DataFrame,    # 特征数据框
        'times': [...],             # 时间点列表
        'load': np.array            # 负荷值数组
    },
    ...
}
```

### 输出数据格式

```python
multi_comparison = {
    'comparison_days': [1, 3, 7],
    'comparisons': {
        1: {  # 与1天前的对比
            'stage_count_comparison': {...},
            'aligned_stages': [...],
            'significant_differences': [...],
            'behavior_explanations': [...]
        },
        3: {...},
        7: {...}
    },
    'summary': {
        'stage_count_trends': [...],      # 阶段数量变化趋势
        'load_trends': [...],             # 负荷变化趋势
        'time_shift_trends': [...],       # 时间偏移趋势
        'behavior_patterns': [...]        # 综合行为模式
    }
}
```

## 总结

多历史时期负荷对比分析功能通过比较预测日与7/3/1天前的负荷阶段，能够：

1. **识别时间规律**：发现工作日vs周末、假期vs平时的作息时间差异
2. **分析负荷变化**：量化不同时期的用电水平变化
3. **解释行为模式**：基于人的生活习惯提供可理解的变化原因
4. **支持预测验证**：通过历史对比验证预测结果的合理性

这个功能特别适用于：
- 家庭负荷预测的可解释性分析
- 用电行为模式识别
- 节能建议生成
- 异常用电检测
