# 负荷变化可解释性模型

## 概述

本项目实现了一个负荷变化可解释性模型，用于根据提取的特征解释负荷阶段趋势和量值变化的原因。该模型可以帮助用户理解负荷变化背后的驱动因素，为能源管理和优化提供决策支持。

## 主要功能

### 1. 智能负荷阶段划分
- 使用隐马尔可夫模型(HMM)自动识别负荷曲线的不同阶段
- 基于负荷水平和变化模式进行智能分段
- 支持自适应状态数量选择
- 合并短小段落以避免过度分段

### 2. 阶段特征分析
- 提取每个阶段的负荷水平（低/中低/中高/高）
- 分析时间特征（早高峰、白天、晚高峰、夜间）
- 评估环境因素影响（温度、湿度、云量等）
- 识别关键影响因素

### 3. 趋势变化解释
- 分析相邻阶段间的负荷变化率
- 判断变化趋势（稳定、上升、下降、显著变化）
- 提供变化原因的自然语言解释
- 关联时间段和行为模式

### 4. 特征重要性分析
- 计算环境特征与负荷的相关性
- 识别最重要的影响因素
- 提供特征影响的量化评估

### 5. 可视化和报告生成
- 生成负荷曲线与阶段划分可视化
- 阶段负荷水平对比图
- 趋势变化率图表
- 特征重要性分析图
- 环境因素影响雷达图
- 自动生成文本分析报告

## 核心模型架构

### 负荷阶段划分 (`hmm_load_segmentation`)

```python
def hmm_load_segmentation(load_values, n_states='auto', 
                          min_states=3, max_states=5, 
                          min_segment_length=8):
    """
    使用HMM对负荷曲线进行智能分段
    
    参数:
        load_values: 负荷值序列
        n_states: 状态数量（'auto'为自动选择）
        min_states: 最小状态数
        max_states: 最大状态数
        min_segment_length: 最小段长度
    
    返回:
        states: 状态序列
        state_means: 各状态平均负荷
        segments: 段落信息列表
    """
```

### 负荷变化解释 (`explain_load_changes`)

```python
def explain_load_changes(segments, feat_df, pred_times, load_values):
    """
    分析负荷阶段变化的原因
    
    参数:
        segments: 负荷分段信息
        feat_df: 特征数据框
        pred_times: 预测时间点
        load_values: 负荷值数组
    
    返回:
        explanations: 包含以下内容的字典
            - segment_analysis: 各阶段详细分析
            - trend_analysis: 趋势变化分析
            - feature_importance: 特征重要性
            - environmental_impact: 环境因素影响
    """
```

## 使用方法

### 方式1：集成到预测系统中

在现有的负荷预测系统中，可解释性模型已自动集成。进行预测时会自动生成解释分析。

```bash
python train_household_forecast.py
# 选择预测模式
# 选择日期进行预测
# 系统会自动生成预测结果和可解释性分析
```

输出文件包括：
- `prediction_with_stages_YYYYMMDD.png` - 预测结果与阶段划分图
- `explanation_report_YYYYMMDD.txt` - 可解释性分析报告
- `explanation_viz_YYYYMMDD.png` - 可解释性可视化图
- `explanation_YYYYMMDD.json` - 可解释性分析数据(JSON格式)

### 方式2：独立运行演示

使用演示脚本快速体验可解释性模型功能：

```bash
python load_interpretability_demo.py
```

该脚本会：
1. 生成模拟的一天负荷数据（96个15分钟间隔点）
2. 进行智能阶段划分
3. 分析各阶段特征和影响因素
4. 分析阶段间趋势变化
5. 生成可视化图表和文本报告

输出文件：
- `/tmp/load_interpretability_demo.png` - 可视化结果
- `/tmp/load_interpretability_report.txt` - 分析报告

## 模型输出示例

### 阶段分析示例

```
阶段 1:
  时间范围: 0.0h - 6.0h
  负荷水平: 低负荷 (平均: 0.50 kW)
  关键影响因素:
    • 低温(8.5°C)可能增加供暖负荷
    • 夜间时段 - 睡眠、待机负荷

阶段 2:
  时间范围: 6.0h - 9.0h
  负荷水平: 高负荷 (平均: 2.50 kW)
  关键影响因素:
    • 温度适中(18.0°C)
    • 早高峰时段 - 起床、早餐活动
```

### 趋势变化示例

```
阶段 1 → 阶段 2:
  变化趋势: 显著上升
  负荷变化: +2.00 kW (+400.0%)
  变化原因:
    • 负荷大幅增加400.0%
    • 进入早晨时段，家庭活动增加
```

### 特征重要性示例

```
最重要的环境特征:
  • temperature (相关系数: +0.456)
  • cloudCover (相关系数: -0.234)
  • humidity (相关系数: +0.189)

特征影响解释:
  • temperature与负荷呈正相关(相关系数=+0.456)
  • cloudCover与负荷呈负相关(相关系数=-0.234)
```

## 技术实现

### 依赖库

- `numpy` - 数值计算
- `pandas` - 数据处理
- `matplotlib` - 可视化
- `scipy` - 科学计算
- `scikit-learn` - 机器学习
- `hmmlearn` - 隐马尔可夫模型（可选）

### 关键算法

1. **HMM负荷分段**
   - 使用高斯隐马尔可夫模型识别负荷状态
   - 自动选择最优状态数量
   - 应用中值滤波减少噪声
   - 合并短小段落

2. **特征提取**
   - 负荷统计特征（均值、方差、峰态）
   - 时间特征（小时、分钟）
   - 环境特征（温度、湿度、云量等）
   - 滞后特征（1天前、7天前）

3. **相关性分析**
   - 计算Pearson相关系数
   - 识别显著相关特征
   - 排序特征重要性

4. **自然语言生成**
   - 基于规则的解释生成
   - 结合时间模式和特征值
   - 生成可读的分析报告

## 应用场景

1. **负荷预测解释**
   - 解释预测结果的合理性
   - 识别异常预测原因
   - 提供预测置信度

2. **用电行为分析**
   - 识别用户用电模式
   - 发现异常用电行为
   - 优化用电建议

3. **能源管理决策**
   - 需求响应策略制定
   - 负荷调度优化
   - 能效改进方案

4. **故障诊断**
   - 识别设备异常
   - 分析负荷异常原因
   - 预防性维护建议

## 模型优势

1. **自动化** - 全自动阶段识别和分析，无需人工干预
2. **可解释** - 提供清晰的自然语言解释
3. **多维度** - 综合考虑时间、环境、行为等多种因素
4. **可视化** - 直观的图表展示分析结果
5. **灵活性** - 支持不同时间粒度和数据格式
6. **扩展性** - 易于添加新的特征和分析维度

## 未来改进方向

1. **深度学习集成**
   - 使用注意力机制识别关键时间点
   - 基于Transformer的序列建模
   - 端到端的可解释性框架

2. **因果分析**
   - 引入因果推断方法
   - 区分相关性和因果性
   - 识别真实的影响因素

3. **用户反馈学习**
   - 收集用户反馈
   - 优化解释质量
   - 个性化解释风格

4. **实时分析**
   - 支持流式数据处理
   - 在线更新分析模型
   - 实时异常检测

5. **多尺度分析**
   - 支持小时、日、周、月多尺度
   - 跨尺度模式识别
   - 长期趋势分析

## 参考文献

1. Hidden Markov Models for load pattern segmentation
2. Interpretable Machine Learning in Energy Systems
3. Feature importance analysis in time series forecasting
4. Explainable AI for smart grid applications

## 联系方式

如有问题或建议，请通过以下方式联系：
- GitHub Issues: [项目地址](https://github.com/pandeny/code)
- Email: [项目维护者邮箱]

## 许可证

[项目许可证信息]
