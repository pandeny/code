# æ—¶é—´åç§»æ£€æµ‹åŠŸèƒ½å®ç°æ€»ç»“
# Time Shift Detection Implementation Summary

## åŠŸèƒ½æ¦‚è¿° (Feature Overview)

æœ¬æ¬¡å®ç°ä¸ºå†å²è´Ÿè·å¯¹æ¯”åˆ†æåŠŸèƒ½æ·»åŠ äº†**é˜¶æ®µæ—¶é—´åç§»æ£€æµ‹**èƒ½åŠ›ï¼Œèƒ½å¤Ÿè¯†åˆ«å’Œè§£é‡Šè´Ÿè·é˜¶æ®µåœ¨æ—¶é—´è½´ä¸Šçš„å·¦ç§»ï¼ˆæå‰ï¼‰æˆ–å³ç§»ï¼ˆæ¨è¿Ÿï¼‰ç°è±¡ã€‚

This implementation adds **stage time shift detection** capability to the historical load comparison feature, enabling identification and explanation of leftward (earlier) or rightward (later) movement of load stages on the time axis.

## å®ç°çš„åŠŸèƒ½ (Implemented Features)

### 1. æ—¶é—´åç§»è®¡ç®— (Time Shift Calculation)
- è®¡ç®—æ¯ä¸ªå¯¹é½é˜¶æ®µçš„ä¸­å¿ƒç‚¹æ—¶é—´å·®
- æ­£å€¼è¡¨ç¤ºå³ç§»ï¼ˆæ¨è¿Ÿï¼‰ï¼Œè´Ÿå€¼è¡¨ç¤ºå·¦ç§»ï¼ˆæå‰ï¼‰
- å•ä½ï¼šå°æ—¶

### 2. æ˜¾è‘—åç§»æ£€æµ‹ (Significant Shift Detection)
- æ£€æµ‹æ ‡å‡†ï¼š|æ—¶é—´åç§»| >= 1.0 å°æ—¶
- ä¸è´Ÿè·å·®å¼‚æ£€æµ‹ï¼ˆ>20%ï¼‰å¹¶è¡Œå·¥ä½œ
- ä»»ä¸€æ¡ä»¶æ»¡è¶³å³æ ‡è®°ä¸ºæ˜¾è‘—å·®å¼‚é˜¶æ®µ

### 3. åˆ†é˜¶æ®µè§£é‡Š (Stage-Specific Explanations)
æ ¹æ®é˜¶æ®µç±»å‹æä¾›é’ˆå¯¹æ€§è§£é‡Šï¼š

#### æ—©é«˜å³°æ—¶æ®µ (6-9h)
- æ¨è¿Ÿï¼šå‘¨æœ«/å‡æ—¥èµ·åºŠæ—¶é—´æ¨è¿Ÿã€ä½œæ¯è°ƒæ•´
- æå‰ï¼šå·¥ä½œæ—¥ä½œæ¯æå‰ã€æ—©èµ·ä¹ æƒ¯å…»æˆ

#### åˆé—´æ—¶æ®µ (12-14h)
- æ¨è¿Ÿï¼šç”¨é¤æ—¶é—´æ¨è¿Ÿã€åˆä¼‘ä¹ æƒ¯æ”¹å˜
- æå‰ï¼šç”¨é¤æ—¶é—´æå‰

#### æ™šé«˜å³°æ—¶æ®µ (18-22h)
- æ¨è¿Ÿï¼šä¸‹ç­/å›å®¶æ—¶é—´æ¨è¿Ÿã€æ™šé¤æ—¶é—´è°ƒæ•´
- æå‰ï¼šä¸‹ç­/å›å®¶æ—¶é—´æå‰

#### å¤œé—´æ—¶æ®µ (22h-6h)
- æ¨è¿Ÿï¼šå°±å¯æ—¶é—´æ¨è¿Ÿã€å¤œé—´æ´»åŠ¨å¢åŠ 
- æå‰ï¼šå°±å¯æ—¶é—´æå‰

### 4. æ•´ä½“æ¨¡å¼åˆ†æ (Overall Pattern Analysis)
ç»Ÿè®¡å’Œåˆ†æï¼š
- æ˜¾è‘—åç§»é˜¶æ®µæ•°é‡
- å³ç§»é˜¶æ®µæ•°é‡ vs å·¦ç§»é˜¶æ®µæ•°é‡
- æ•´ä½“åç§»è¶‹åŠ¿ï¼ˆå³ç§»ä¸ºä¸»/å·¦ç§»ä¸ºä¸»/æ··åˆï¼‰
- å¯èƒ½çš„åŸå› åˆ†æ

## ç¤ºä¾‹è¾“å‡º (Example Output)

### é€é˜¶æ®µåˆ†æ
```
å½“å‰é˜¶æ®µ2 â†” å†å²é˜¶æ®µ2:
  æ—¶é—´èŒƒå›´: 8.0h-11.0h (å‘¨æœ«) vs 6.0h-9.0h (å·¥ä½œæ—¥)
  â° æ—¶é—´åç§»: 2.0 å°æ—¶ â†’ (å³ç§»/æ¨è¿Ÿ)
  è´Ÿè·æ°´å¹³: 2.80 kW (å‘¨æœ«) vs 2.50 kW (å·¥ä½œæ—¥)
  è´Ÿè·å·®å¼‚: +0.30 kW (+12.0%)
```

### å·®å¼‚æ˜¾è‘—é˜¶æ®µ
```
é˜¶æ®µ2 (å‘¨æœ«æ—¶é—´: 8.0h-11.0h, å·¥ä½œæ—¥æ—¶é—´: 6.0h-9.0h):
  â° æ—¶é—´åç§»: 2.0 å°æ—¶ (å³ç§»/æ¨è¿Ÿ)
  ğŸ“Š è´Ÿè·å˜åŒ–: +0.30 kW (+12.0%)
  ğŸ’¡ è¡Œä¸ºè§£é‡Š:
      â€¢ æ—©é«˜å³°é˜¶æ®µæ—¶é—´æ¨è¿Ÿçº¦2.0å°æ—¶ï¼Œå¯èƒ½æ˜¯ï¼šå› ä¸ºå‘¨æœ«/å‡æ—¥å¯¼è‡´èµ·åºŠæ—¶é—´æ¨è¿Ÿã€æˆ–ä½œæ¯æ—¶é—´è°ƒæ•´
      â€¢ æ—©é«˜å³°æ—¶æ®µè´Ÿè·å¢åŠ ï¼Œå¯èƒ½æ˜¯ï¼šèµ·åºŠæ—¶é—´æå‰ã€æ—©é¤å‡†å¤‡æ›´å¤æ‚ã€æˆ–å¢åŠ äº†çƒ­æ°´å™¨/å’–å•¡æœºä½¿ç”¨
```

### æ€»ä½“åˆ†æ
```
æ—¶é—´åç§»æ¨¡å¼ï¼šæ•´ä½“å³ç§»(æ¨è¿Ÿ)ä¸ºä¸»ï¼Œ3ä¸ªé˜¶æ®µæœ‰æ˜¾è‘—æ—¶é—´åç§»ï¼ˆ2ä¸ªå³ç§»ï¼Œ1ä¸ªå·¦ç§»ï¼‰
åç§»åŸå› ï¼šå¯èƒ½æ˜¯å‘¨æœ«/å‡æ—¥ä½œæ¯æ¨è¿Ÿã€å·¥ä½œæ—¶é—´è°ƒæ•´ã€æˆ–ç”Ÿæ´»ä¹ æƒ¯æ”¹å˜
æ•´ä½“è¶‹åŠ¿ï¼šè´Ÿè·å¢åŠ ä¸ºä¸»(3ä¸ªé˜¶æ®µå¢åŠ ï¼Œ1ä¸ªé˜¶æ®µå‡å°‘)
å¯èƒ½åŸå› ï¼šå®¶åº­æ´»åŠ¨å¢åŠ ã€åœ¨å®¶æ—¶é—´å»¶é•¿ã€æ–°å¢ç”¨ç”µè®¾å¤‡ã€æˆ–å­£èŠ‚æ€§ç”¨ç”µéœ€æ±‚å˜åŒ–
```

## åº”ç”¨åœºæ™¯ (Use Cases)

### 1. å·¥ä½œæ—¥ vs å‘¨æœ«å¯¹æ¯”
- **å…¸å‹ç°è±¡**ï¼šæ—©é«˜å³°å³ç§»2å°æ—¶ï¼ˆ6-9h â†’ 8-11hï¼‰
- **è§£é‡Š**ï¼šå‘¨æœ«ç¡æ‡’è§‰ï¼Œèµ·åºŠæ—¶é—´æ¨è¿Ÿ

### 2. å†¬å­£ vs å¤å­£å¯¹æ¯”
- **å…¸å‹ç°è±¡**ï¼šæ™šé«˜å³°å·¦ç§»1-2å°æ—¶
- **è§£é‡Š**ï¼šå†¬å­£å¤©é»‘æ—©ï¼Œæ´»åŠ¨æ—¶é—´æå‰

### 3. èŠ‚å‡æ—¥ vs å¸¸è§„æ—¥å¯¹æ¯”
- **å…¸å‹ç°è±¡**ï¼šå¤šä¸ªé˜¶æ®µæ•´ä½“å³ç§»
- **è§£é‡Š**ï¼šå‡æ—¥ä½œæ¯æ¨è¿Ÿï¼Œæ´»åŠ¨æ›´è‡ªç”±

### 4. åœ¨å®¶åŠå…¬ vs å¤–å‡ºå·¥ä½œå¯¹æ¯”
- **å…¸å‹ç°è±¡**ï¼šä¸Šåˆé˜¶æ®µæ—¶é—´åˆ†å¸ƒå˜åŒ–
- **è§£é‡Š**ï¼šå·¥ä½œæ¨¡å¼æ”¹å˜ï¼Œåœ¨å®¶æ—¶é—´å¢åŠ 

## æŠ€æœ¯å®ç° (Technical Implementation)

### æ ¸å¿ƒç®—æ³•
```python
# è®¡ç®—æ—¶é—´åç§»
curr_mid_hour = (curr_start_hour + curr_end_hour) / 2
hist_mid_hour = (hist_start_hour + hist_end_hour) / 2
time_shift = curr_mid_hour - hist_mid_hour

# åˆ¤æ–­åç§»æ–¹å‘
if time_shift > 0:
    direction = 'å³ç§»(æ¨è¿Ÿ)'
elif time_shift < 0:
    direction = 'å·¦ç§»(æå‰)'
else:
    direction = 'æ— åç§»'
```

### æ£€æµ‹æ ‡å‡†
```python
# æ˜¾è‘—å·®å¼‚æ£€æµ‹
has_load_diff = abs(load_difference_percent) > 20
has_time_shift = abs(time_shift) >= 1.0

if has_load_diff or has_time_shift:
    # æ ‡è®°ä¸ºæ˜¾è‘—å·®å¼‚é˜¶æ®µ
    significant_differences.append(stage)
```

## æµ‹è¯•è¦†ç›– (Test Coverage)

### å•å…ƒæµ‹è¯•
1. `test_time_shift_detection()` - å³ç§»æ£€æµ‹
2. `test_left_shift_detection()` - å·¦ç§»æ£€æµ‹
3. åŸæœ‰çš„å¯¹é½æµ‹è¯• - å‘åå…¼å®¹æ€§

### é›†æˆæµ‹è¯•
- `demo_time_shift.py` - å®Œæ•´åœºæ™¯æ¼”ç¤º
- å·¥ä½œæ—¥ vs å‘¨æœ«å¯¹æ¯”
- è¾“å‡ºå®Œæ•´æŠ¥å‘Š

## æ–‡ä»¶ä¿®æ”¹ (Files Modified)

### æ ¸å¿ƒå®ç°
1. `train_household_forecast.py`
   - `compare_with_historical_stages()` å‡½æ•°
   - `generate_explanation_report()` å‡½æ•°

2. `historical_comparison_demo.py`
   - `compare_with_historical_stages_standalone()` å‡½æ•°

### æµ‹è¯•æ–‡ä»¶
3. `test_time_shift_detection.py` - æ–°å¢
4. `demo_time_shift.py` - æ–°å¢

### æ–‡æ¡£æ›´æ–°
5. `HISTORICAL_COMPARISON_GUIDE.md`

## å‘åå…¼å®¹æ€§ (Backward Compatibility)

âœ… å®Œå…¨å‘åå…¼å®¹
- æ‰€æœ‰åŸæœ‰æµ‹è¯•é€šè¿‡
- æ–°å¢å­—æ®µä¸ºå¯é€‰ï¼Œä¸å½±å“ç°æœ‰åŠŸèƒ½
- æŠ¥å‘Šæ ¼å¼ä¿æŒä¸€è‡´ï¼Œä»…æ·»åŠ æ–°ä¿¡æ¯

## ä½¿ç”¨æ–¹æ³• (Usage)

### è¿è¡Œæ¼”ç¤º
```bash
python demo_time_shift.py
```

### è¿è¡Œæµ‹è¯•
```bash
python test_time_shift_detection.py
python test_historical_comparison.py
```

### åœ¨ä»£ç ä¸­ä½¿ç”¨
```python
from historical_comparison_demo import compare_with_historical_stages_standalone

comparison = compare_with_historical_stages_standalone(
    current_segments,
    historical_segments,
    current_feat_df,
    historical_feat_df,
    current_times,
    historical_times,
    current_load,
    historical_load
)

# è®¿é—®æ—¶é—´åç§»ä¿¡æ¯
for stage in comparison['aligned_stages']:
    time_shift = stage['time_shift']
    print(f"Time shift: {time_shift:.2f}h")

# è®¿é—®æ˜¾è‘—å·®å¼‚ï¼ˆå«æ—¶é—´åç§»ï¼‰
for diff in comparison['significant_differences']:
    if 'time_shift' in diff:
        print(f"Shift direction: {diff['shift_direction']}")
```

## æ€»ç»“ (Summary)

æœ¬å®ç°å®Œæ•´æ»¡è¶³äº†é—®é¢˜é™ˆè¿°ä¸­çš„è¦æ±‚ï¼š

âœ… **é˜¶æ®µæ•°é‡å¢å‡** - åŸæœ‰åŠŸèƒ½
âœ… **é˜¶æ®µçš„å·¦ç§»æˆ–å³ç§»** - æœ¬æ¬¡æ–°å¢ â­
âœ… **é˜¶æ®µä¸­è´Ÿè·çš„å¢åŠ å‡å°‘** - åŸæœ‰åŠŸèƒ½
âœ… **ç»“åˆäººçš„è¡Œä¸ºè¿›è¡Œè§£é‡Š** - å¢å¼ºå®Œå–„

ç‰¹åˆ«æ˜¯é’ˆå¯¹"æ—©é«˜å³°åç§»2å°æ—¶"è¿™æ ·çš„åœºæ™¯ï¼Œç°åœ¨èƒ½å¤Ÿï¼š
1. è‡ªåŠ¨æ£€æµ‹åˆ°æ—¶é—´åç§»ï¼ˆ+2å°æ—¶ï¼‰
2. è¯†åˆ«ä¸ºå³ç§»ï¼ˆæ¨è¿Ÿï¼‰
3. æä¾›åŸºäºè¡Œä¸ºçš„è§£é‡Šï¼ˆå‘¨æœ«èµ·åºŠæ—¶é—´æ¨è¿Ÿï¼‰
4. åˆ†ææ•´ä½“åç§»æ¨¡å¼

---

å®ç°æ—¥æœŸï¼š2025-10-14
ç‰ˆæœ¬ï¼š1.0
